<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Tebasaenterar - Detalle de Activo Financiero</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&amp;display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&amp;display=swap"
    rel="stylesheet" />
  <script id="tailwind-config">
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            "dark-gray": "#515455",
            "deep-blue": "#033778",
            "light-gray": "#b1b0b1",
            "bright-blue": "#00aadb",
            "pure-white": "#ffffff",
          },
          fontFamily: {
            "display": ["Lexend"]
          },
          borderRadius: { "DEFAULT": "0px", "lg": "0px", "xl": "0px", "full": "9999px" },
        },
      },
    }
  </script>

  <style type="text/tailwindcss">
    body {
            font-family: 'Lexend', sans-serif;
            background-color: #ffffff;
            color: #033778;
        }
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background-color: #033778;
            color: #ffffff;
            padding: 12px 0;
            position: fixed;
            bottom: 0;
            z-index: 50;
            border-top: 4px solid #00aadb;
        }
        .ticker {
            display: inline-block;
            white-space: nowrap;
            padding-right: 100%;
            animation: ticker 45s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
        .bureaucratic-border {
            border: 4px solid #033778;
        }
        .watermark {
            transform: rotate(-30deg);
            pointer-events: none;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>

<body class="min-h-screen bg-pure-white text-deep-blue">
  <header
    class="sticky top-0 z-40 w-full border-b-4 border-solid border-deep-blue bg-pure-white px-4 md:px-20 lg:px-40 py-4">
    <div class="flex items-center justify-between whitespace-nowrap">
      <div class="flex items-center gap-8">
        <a href="/">
          <div class="flex items-center gap-4 text-deep-blue">
            <div class="size-8">
              <span class="material-symbols-outlined text-4xl">sports_soccer</span>
            </div>
            <h2 class="text-deep-blue text-2xl font-black leading-tight tracking-tight uppercase">
              Tebasaenterar
            </h2>
          </div>
        </a>
        <nav class="hidden lg:flex items-center gap-9">
          <a class="text-deep-blue hover:text-bright-blue transition-colors text-sm font-bold uppercase tracking-wider"
            href="/">Boletín Oficial</a>
          <a class="text-deep-blue hover:text-bright-blue transition-colors text-sm font-bold uppercase tracking-wider"
            href="/marketplace">Mercado de Palancas</a>
          {% if user %}
          <a class="text-deep-blue hover:text-bright-blue transition-colors text-sm font-bold uppercase tracking-wider"
            href="/palancas">Mis palancas</a>
          {% endif %}
        </nav>
      </div>
      <div class="flex flex-1 justify-end gap-4 md:gap-8 items-center">
        {% if user %}
        <a href="/dashboard"
          class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden h-10 px-6 bg-bright-blue text-pure-white text-sm font-black uppercase leading-normal tracking-widest hover:brightness-110 border-2 border-deep-blue">
          <span class="truncate">Expediente: #{{user}}</span>
        </a>
        {% else %}
        <a href="/login"
          class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden h-10 px-6 bg-bright-blue text-pure-white text-sm font-black uppercase leading-normal tracking-widest hover:brightness-110 border-2 border-deep-blue">
          <span class="truncate">Iniciar Sesión</span>
        </a>
        {% endif %}

      </div>
    </div>
  </header>
  <main class="max-w-[1400px] mx-auto pb-32 pt-10 px-4">
    <div class="mb-6 flex gap-2 text-[10px] font-black uppercase">
      <a class="opacity-50 hover:opacity-100" href="#">Mercado</a>
      <span>/</span>
      <a class="opacity-50 hover:opacity-100" href="#">Activos Financieros</a>
      <span>/</span>
      <span class="text-bright-blue" id="item-id">ID-ACTIVO_{{ "%03d" | format(item.id) }}</span>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <div class="lg:col-span-4">
        <div class="relative bureaucratic-border bg-light-gray aspect-[3/4] overflow-hidden grayscale group">
          <div id="item-image" class="w-full h-full bg-cover bg-center"
            style="background-image: url('{{ item.image }}');">
          </div>
          <div class="absolute bottom-0 left-0 right-0 bg-deep-blue p-4 text-pure-white">
            <p class="text-xl font-black" id="item-badge">{{ item.badge }}</p>
          </div>
        </div>

      </div>
      <div class="lg:col-span-5 flex flex-col gap-8">
        <div class="border-b-8 border-deep-blue pb-4">
          <h1 class="text-5xl font-black uppercase tracking-tighter">{{ item.title }}</h1>
          <p class="text-lg font-bold text-bright-blue uppercase">Categoría: {{ item.category }}</p>
        </div>
        <div class="grid grid-cols-1 gap-4">
          <h3 class="text-xs font-black uppercase bg-deep-blue text-pure-white px-3 py-1 w-fit">Descripción</h3>
          <div class="flex flex-col gap-6 bg-light-gray/20 p-6 bureaucratic-border">
            <p class="text-sm font-bold leading-tight">{{ item.description }}</p>
          </div>
        </div>
        <div class="flex flex-col gap-4">
          <h3 class="text-xs font-black uppercase bg-deep-blue text-pure-white px-3 py-1 w-fit">Precio</h3>
          <div class="border-l-4 border-deep-blue ml-2 pl-6 py-2 flex flex-col gap-2">
            <p class="text-4xl font-black text-bright-blue">
             {{ "{:,.0f}".format(item.price) }} MILLONES €
            </p>
            <p class="text-xs font-bold uppercase text-dark-gray">Precio por unidad de palanca</p>
          </div>
        </div>
      </div>
      <div class="lg:col-span-3">
        <aside class="sticky top-28 flex flex-col gap-6">
          {% if user %}
          <form id="checkout-form" onsubmit="return false;">
            <div class="bg-pure-white bureaucratic-border p-6 shadow-[8px_8px_0px_0px_#033778]">
              <div class="flex items-center gap-2 mb-6 border-b-2 border-deep-blue pb-4">
                <span class="material-symbols-outlined text-bright-blue text-2xl">calculate</span>
                <h2 class="text-xl font-black uppercase tracking-tighter">Comprar</h2>
              </div>
              <div class="flex flex-col gap-4">
                <div class="flex flex-col gap-1">
                  <label class="text-[10px] font-black uppercase">Cantidad (Máximo 8)</label>
                  <input type="number" id="cantidad" name="cantidad" min="1" max="8" value="1" required>
                </div>

                <div class="flex flex-col gap-1 bg-bright-blue/10 p-3 border-2 border-bright-blue rounded">
                  <p class="text-[10px] font-black uppercase text-bright-blue">Balance Disponible</p>
                  <p class="text-2xl font-black text-bright-blue">
                    {{ "{:,.0f}".format(balance) }} MILLONES €
                  </p>
                </div>

                <div class="flex flex-col gap-1">
                  <label class="text-[10px] font-black uppercase">Precio Total (MILLONES €)</label>
                  <div class="p-3 bg-light-gray/20 border-2 border-deep-blue">
                    <p class="text-xl font-black text-bright-blue" id="total-price">
                        {{ "{:,.0f}".format(item.price) }} €
                    </p>
                  </div>
                </div>

                <div id="balance-warning" class="hidden p-3 bg-red-100 border-2 border-red-500 rounded">
                  <p class="text-sm font-bold text-red-700">
                    <span class="material-symbols-outlined text-lg align-middle">warning</span>
                    Balance insuficiente. Necesitas <span id="needed-amount" class="font-black">0</span> millones € más.
                  </p>
                </div>

                <button type="submit"
                  id="apply-button"
                  class="w-full py-4 mt-2 bg-bright-blue text-pure-white font-black uppercase tracking-widest border-2 border-deep-blue hover:translate-x-1 hover:translate-y-1 transition-all shadow-[4px_4px_0px_0px_#033778] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-x-0 disabled:hover:translate-y-0"
                  disabled>
                  Aplicar palanca
                </button>
              </div>
            </div>
          </form>
          {% else %}
          <div class="bg-pure-white bureaucratic-border p-6 shadow-[8px_8px_0px_0px_#033778]">
            <div class="flex items-center gap-2 mb-6 border-b-2 border-deep-blue pb-4">
              <span class="material-symbols-outlined text-bright-blue text-2xl">lock</span>
              <h2 class="text-xl font-black uppercase tracking-tighter">Acceso Restringido</h2>
            </div>
            <div class="flex flex-col gap-4 text-center">
              <p class="text-sm font-bold text-dark-gray">
                Debes iniciar sesión como accionista hipotecado para aplicar esta palanca financiera.
              </p>
              <a href="/login"
                class="w-full py-4 mt-2 bg-bright-blue text-pure-white font-black uppercase tracking-widest border-2 border-deep-blue hover:translate-x-1 hover:translate-y-1 transition-all shadow-[4px_4px_0px_0px_#033778] flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">login</span>
                <span>Iniciar Sesión</span>
              </a>
            </div>
          </div>
          {% endif %}
        </aside>
      </div>
    </div>
    <section class="mt-16 border-t-4 border-deep-blue pt-10">
      <h2 class="text-2xl font-black uppercase mb-8 flex items-center gap-3">
        <span class="material-symbols-outlined text-3xl">fact_check</span>
        Expert Audit Comments (Viabilidad Financiera)
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="bg-light-gray/30 p-6 border-l-8 border-deep-blue">
          <p class="text-xs font-black uppercase mb-4 text-bright-blue">Auditor Senior #41</p>
          <p class="text-sm italic font-medium leading-relaxed">
            "Desde un punto de vista puramente imaginario, los números cuadran si omitimos la columna de gastos y
            multiplicamos los ingresos por el número de seguidores en redes sociales."
          </p>
        </div>
        <div class="bg-light-gray/30 p-6 border-l-8 border-deep-blue">
          <p class="text-xs font-black uppercase mb-4 text-bright-blue">Departamento de 'Fair Play'</p>
          <p class="text-sm italic font-medium leading-relaxed">
            "Hemos revisado el contrato y creemos que el jugador puede cobrar en NFTs de edición limitada del césped del
            estadio para no computar como masa salarial."
          </p>
        </div>
        <div class="bg-light-gray/30 p-6 border-l-8 border-deep-blue">
          <p class="text-xs font-black uppercase mb-4 text-bright-blue">Consultoría Externa Z</p>
          <p class="text-sm italic font-medium leading-relaxed">
            "Recomendamos la venta inmediata del activo a una liga del desierto antes de que la amortización consuma el
            oxígeno de las oficinas centrales."
          </p>
        </div>
      </div>
    </section>
  </main>
  <div class="ticker-wrap">
    <div class="ticker">
      <span class="mx-6 font-black uppercase text-bright-blue">[ALERTA]</span> DEUDA TOTAL DE LA LIGA SUPERANDO EL PIB
      DE VARIOS PAÍSES...
      <span class="mx-6 font-black uppercase text-bright-blue">[NOTIFICACIÓN]</span> REUNIÓN A MEDIANOCHE PARA CAMBIAR
      LAS REGLAS DE INSCRIPCIÓN...
      <span class="mx-6 font-black uppercase text-bright-blue">[CVC]</span> DINERO GRATIS* (*SUJETO A 50 AÑOS DE
      ARREPENTIMIENTO)...
      <span class="mx-6 font-black uppercase text-bright-blue">[VAR]</span> SE CONFIRMA QUE EL FUERA DE JUEGO SE MIDE
      POR EL TAMAÑO DE LA NÓMINA...
      <span class="mx-6 font-black uppercase text-bright-blue">[CONTABLE]</span> LAS PALANCAS AHORA SE CONSIDERAN
      GIMNASIA OLÍMPICA FINANCIERA...
    </div>
  </div>

  <script>
    // Obtener el parámetro id de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const itemId = parseInt(urlParams.get('id'));

    let currentItem = null;

    function updatePrice() {
      if (!currentItem) return;

      const cantidadInput = document.getElementById('cantidad');
      if (!cantidadInput) return;

      let cantidad = parseInt(cantidadInput.value) || 1;

      // Validar máximo
      if (cantidad > 8) {
        cantidad = 8;
        cantidadInput.value = 8;
      }

      // Validar mínimo
      if (cantidad < 1) {
        cantidad = 1;
        cantidadInput.value = 1;
      }

      const totalPrice = currentItem.price * cantidad;
      const totalPriceElement = document.getElementById('total-price');
      if (totalPriceElement) {
        totalPriceElement.textContent = totalPrice.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' €';
      }

      // Verificar si hay suficiente balance
      const balance = parseFloat("{{ balance }}") || 0;
      const applyButton = document.getElementById('apply-button');
      const balanceWarning = document.getElementById('balance-warning');
      const neededAmount = document.getElementById('needed-amount');

      if (applyButton && balanceWarning) {
        if (totalPrice > balance) {
          applyButton.disabled = true;
          balanceWarning.classList.remove('hidden');
          const needed = totalPrice - balance;
          neededAmount.textContent = needed.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        } else {
          applyButton.disabled = false;
          balanceWarning.classList.add('hidden');
        }
      }
    }

    // Establecer currentItem desde los datos de Jinja
    currentItem = {
      id: parseInt("{{ item.id }}"),
      title: "{{ item.title }}",
      category: "{{ item.category }}",
      description: "{{ item.description }}",
      price: parseFloat("{{ item.price }}"),
      badge: "{{ item.badge }}",
      image: "{{ item.image }}"
    };

    console.log('Item actual:', currentItem);
    updatePrice();

    const cantidadInput = document.getElementById('cantidad');
    if (cantidadInput) {
      cantidadInput.addEventListener('input', updatePrice);

      // Prevenir envío del formulario al presionar Enter
      cantidadInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
        }
      });
    }

    // Agregar listener al formulario (solo si existe)
    const checkoutForm = document.getElementById('checkout-form');
    if (checkoutForm) {
      checkoutForm.addEventListener('submit', function (e) {
        e.preventDefault();

        // Serializa los datos del formulario a un objeto JS
        const formData = new FormData(this);
        const cart = {};
        formData.forEach((value, key) => { cart[key] = value; });
        cart['user'] = '{{ user }}';
        cart['item_price'] = currentItem ? currentItem.price : 0;
        cart['total_price'] = (currentItem.price * parseInt(formData.get('cantidad') || 1));
        cart['item_id'] = currentItem ? currentItem.id : null;
        cart['item_title'] = currentItem ? currentItem.title : null;
        cart['item_category'] = currentItem ? currentItem.category : null;
        cart['item_badge'] = currentItem ? currentItem.badge : null;
        cart['item_image'] = currentItem ? currentItem.image : null;
        cart['item_description'] = currentItem ? currentItem.description : null;

        console.log('Carrito a guardar:', cart);
        // Opcional: añade info de eventoId si quieres
        cart['id'] = itemId;
        fetch('/save_cart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded', // así lo espera Flask
          },
          body: `cart=${encodeURIComponent(JSON.stringify(cart))}`
        })
          .then(res => res.text())
          .then(msg => {
            setTimeout(() => {
              window.location.href = '/palancas'; // <--- Aquí va la redirección
            }, 1000);
          })
          .catch((err) => {
            console.error('Error al guardar el carrito:', err);
          });
      });
    }

  </script>
</body>

</html>